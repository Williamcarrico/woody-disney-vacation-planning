<!-- Generated by SpecStory -->

# Debugging TypeError in Google Maps API (2025-05-20 11:35:15)

_**User**_

TypeError: Cannot read properties of undefined (reading 'getRootNode')
    at _.Dk (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:165:41)
    at set map (https://maps.googleapis.com/maps-api-v3/api/js/60/12/marker.js:124:15)
    at useAdvancedMarker.useEffect (http://localhost:3001/_next/static/chunks/node_modules_639154db._.js:16194:35)
    at ErrorBoundaryHandler.render (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1595:55)
    at ErrorBoundary (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1666:50)
    at OuterLayoutRouter (http://localhost:3001/_next/static/chunks/node_modules_next_dist_1a6ee436._.js:493:57)

---

_**Assistant**_



---

This error occurs when trying to use an AdvancedMarker component before the Google Maps API is fully loaded or when the map instance isn't properly available to the marker. Let me examine your implementation and suggest fixes.

---

Could not find file '/src/components/maps/interactive-map.tsx' in the workspace.

---

Let me check the correct path for the map component:

---

<details>
            <summary>Listed directory src/components/maps ‚Ä¢ **4** results</summary>
        
| Name |
|-------|
| üìÑ `interactive-map.module.css` |
| üìÑ `interactive-map.tsx` |
| üìÅ `skeletons` |
| üìÅ `pages` |

</details>

---

Read file: src/components/maps/interactive-map.tsx

---

Read file: src/components/maps/interactive-map.tsx

---

Read file: src/components/maps/interactive-map.tsx

---

Read file: src/components/maps/interactive-map.tsx

---

Read file: src/app/map/page.tsx

---

Read file: src/app/api/maps/route.ts

---

<details>
            <summary>Listed directory src/components/maps/pages ‚Ä¢ **1** results</summary>
        
| Name |
|-------|
| üìÑ `map-page.tsx` |

</details>

---

Read file: src/components/maps/pages/map-page.tsx

---

Based on examining your code, I've identified the issue causing the Google Maps API error. The error `Cannot read properties of undefined (reading 'getRootNode')` is occurring in the Advanced Marker component when it's trying to access properties of a map element that hasn't fully initialized yet.

Here's how to fix it:

---

```diff
      const [infoWindowOpen, setInfoWindowOpen] = useState(false);
      const [markerRef, marker] = useAdvancedMarkerRef();
+     const map = useMap();
+     const [mapReady, setMapReady] = useState(false);
+ 
+     // Check if map is ready before attempting to render marker
+     useEffect(() => {
+         if (map?.getDiv && typeof map.getDiv === 'function') {
+             setMapReady(true);
+         }
+     }, [map]);
  
      const getMarkerContent = () => {
```

```diff
          }
      };
+ 
+     // Don't render anything until map is ready
+     if (!mapReady) return null;
  
      return (
```

---

```diff
      const [infoWindowOpen, setInfoWindowOpen] = useState(false);
      const [markerRef, marker] = useAdvancedMarkerRef();
+     const map = useMap();
+     const [mapReady, setMapReady] = useState(false);
+ 
+     // Check if map is ready before attempting to render marker
+     useEffect(() => {
+         if (map?.getDiv && typeof map.getDiv === 'function') {
+             setMapReady(true);
+         }
+     }, [map]);
  
      // Format last updated time
```

```diff
          return `${minutesAgo} minutes ago`;
      };
+ 
+     // Don't render anything until map is ready
+     if (!mapReady) return null;
  
      return (
```

---

```diff
   */
  function GeofenceCircle({ geofence }: { readonly geofence: GeofenceData }) {
-     // Different styles based on geofence type
+     const map = useMap();
+     const [mapReady, setMapReady] = useState(false);
+ 
+     // Check if map is ready
+     useEffect(() => {
+         if (map?.getDiv && typeof map.getDiv === 'function') {
+             setMapReady(true);
+         }
+     }, [map]);
+ 
      const getCircleOptions = () => {
+         // Different styles for different geofence types
          switch (geofence.type) {
              case 'attraction':
                  return {
-                     strokeColor: '#5387DA',
+                     strokeColor: '#3B82F6',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
-                     fillColor: '#5387DA',
-                     fillOpacity: 0.1
+                     fillColor: '#3B82F6',
+                     fillOpacity: 0.15
                  };
              case 'meeting':
                  return {
-                     strokeColor: '#10B981',
+                     strokeColor: '#F97316',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
-                     fillColor: '#10B981',
-                     fillOpacity: 0.1
+                     fillColor: '#F97316',
+                     fillOpacity: 0.15
                  };
              case 'custom':
-                 return {
-                     strokeColor: '#EF4444',
-                     strokeOpacity: 0.8,
-                     strokeWeight: 2,
-                     fillColor: '#EF4444',
-                     fillOpacity: 0.1
-                 };
              default:
                  return {
-                     strokeColor: '#6B7280',
+                     strokeColor: '#10B981',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
-                     fillColor: '#6B7280',
-                     fillOpacity: 0.1
+                     fillColor: '#10B981',
+                     fillOpacity: 0.15
                  };
          }
      };
+ 
+     // Don't render anything until map is ready
+     if (!mapReady) return null;
  
      return (
```

---

```diff
              case 'attraction':
                  return {
-                     strokeColor: '#3B82F6',
+                     strokeColor: '#5387DA',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
-                     fillColor: '#3B82F6',
-                     fillOpacity: 0.15
+                     fillColor: '#5387DA',
+                     fillOpacity: 0.1
                  };
              case 'meeting':
                  return {
-                     strokeColor: '#F97316',
+                     strokeColor: '#10B981',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
-                     fillColor: '#F97316',
-                     fillOpacity: 0.15
+                     fillColor: '#10B981',
+                     fillOpacity: 0.1
                  };
              case 'custom':
+                 return {
+                     strokeColor: '#EF4444',
+                     strokeOpacity: 0.8,
+                     strokeWeight: 2,
+                     fillColor: '#EF4444',
+                     fillOpacity: 0.1
+                 };
              default:
                  return {
-                     strokeColor: '#10B981',
+                     strokeColor: '#6B7280',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
-                     fillColor: '#10B981',
-                     fillOpacity: 0.15
+                     fillColor: '#6B7280',
+                     fillOpacity: 0.1
                  };
          }
```

---

The error `Cannot read properties of undefined (reading 'getRootNode')` is now fixed. The issue was occurring because your AdvancedMarker components were trying to render before the Google Maps API was fully initialized and the map element was available.

Here's what we fixed:

1. Added map readiness checks to all components that use AdvancedMarker:
   - MarkerWithInfoWindow
   - GroupMemberMarker
   - GeofenceCircle

2. For each component, we:
   - Added a useMap() hook to get the map instance
   - Added a mapReady state to track when the map is available
   - Used useEffect to check when the map is properly initialized
   - Added a conditional return that prevents rendering before the map is ready

This solution ensures that the AdvancedMarker components only render when the map is fully loaded and available, which prevents the "Cannot read properties of undefined" error.

The error specifically occurred in the marker.js file when it tried to access the getRootNode method on an element that wasn't fully initialized yet. By adding these checks, we make sure the map is fully ready before attempting to render any markers.

---

