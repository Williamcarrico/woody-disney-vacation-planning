<!-- Generated by SpecStory -->

# Implement and update Magic Kingdom Park API (2025-05-29 21:12:39)

_**User**_

Your task is to ensure this API details are implemented with accuracy, precistion, and comprehensive logic. Ensure replace  any API logic that is already implemented  and delete all unused data, API's and code files being replaced. 

Magic Kingdom Park API References::
@https://api.themeparks.wiki/v1/entity/75ea578a-adc8-4116-a54d-dccb60765ef9 
@https://api.themeparks.wiki/v1/entity/e957da41-3552-4cf6-b636-5babc5cbc4e5/children 
@https://api.themeparks.wiki/v1/entity/e957da41-3552-4cf6-b636-5babc5cbc4e5/live 

All data on this page is generated from the following API request:
@https://api.themeparks.wiki/v1/entity/75ea578a-adc8-4116-a54d-dccb60765ef9/live 


{
  "id": "75ea578a-adc8-4116-a54d-dccb60765ef9",
  "name": "Magic Kingdom Park",
  "slug": "magickingdompark",
  "location": {
    "latitude": 28.4160036778,
    "longitude": -81.5811902834,
    "pointsOfInterest": []
  },
  "parentId": "e957da41-3552-4cf6-b636-5babc5cbc4e5",
  "timezone": "America/New_York",
  "entityType": "PARK",
  "destinationId": "e957da41-3552-4cf6-b636-5babc5cbc4e5",
  "externalId": "80007944;entityType=theme-park"
}

Map:
@https://api.themeparks.wiki/entity/e957da41-3552-4cf6-b636-5babc5cbc4e5/live 

Latest Schedule Data:
@https://api.themeparks.wiki/v1/entity/75ea578a-adc8-4116-a54d-dccb60765ef9/schedule

Current Month Data:
@https://api.themeparks.wiki/v1/entity/75ea578a-adc8-4116-a54d-dccb60765ef9/schedule/2025/05  

---

_**Assistant**_



---

I'll help you implement the Magic Kingdom Park API integration using the themeparks.wiki API endpoints. Let me first analyze the existing codebase to understand what needs to be replaced.

---

<details>
            <summary>Searched codebase "park API endpoint route" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/app/api/parks/route.ts` | L1-14 |
| `src/app/api/parks/[parkId]/route.ts` | L66-104 |
| `src/app/api/parks/[parkId]/route.ts` | L36-66 |
| `src/app/api/parks/[parkId]/route.ts` | L1-36 |
| `src/lib/api/themeParks.ts` | L77-90 |
| `src/app/api/analytics/wait-times/route.ts` | L38-44 |
| `src/lib/api/themeParks.ts` | L136-166 |
| `src/types/api.ts` | L28-43 |
| `src/app/api/analytics/wait-times/route.ts` | L555-575 |
| `src/app/api/parks/route.ts` | L14-67 |
| `src/lib/api/themeParks.ts` | L90-113 |
| `src/lib/api/themeParks.ts` | L113-136 |
| `src/lib/schemas/park.schema.ts` | L71-79 |
| `src/app/api/parks/route.ts` | L67-73 |
| `src/lib/api/themeParks.ts` | L166-186 |
| `src/app/api/analytics/wait-times/route.ts` | L193-222 |
| `src/app/api/analytics/wait-times/route.ts` | L507-555 |
| `src/lib/services/map-service.ts` | L1800-1815 |
| `src/app/api/attractions/[attractionId]/wait-times/route.ts` | L936-984 |
| `src/app/api/analytics/wait-times/route.ts` | L102-137 |
| `src/lib/schemas/park.schema.ts` | L79-81 |
| `src/app/api/analytics/wait-times/route.ts` | L1-38 |
| `src/lib/schemas/park.schema.ts` | L14-39 |
| `src/app/api/attractions/[attractionId]/route.ts` | L1-26 |
| `src/app/api/attractions/[attractionId]/wait-times/route.ts` | L1169-1200 |

</details>

---



---

Let me search for types and interfaces to understand the data structures better:

---

<details>
            <summary>Searched codebase "themeparks.wiki API types interfaces" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/types/api.ts` | L1-12 |
| `src/app/api/parks/[parkId]/route.ts` | L1-36 |
| `src/types/api.ts` | L28-43 |
| `src/lib/api/themeParks.ts` | L1-50 |
| `src/lib/data/parks.ts` | L1-14 |
| `docs/Disney Vacation Planning, API Integration_.txt` | L233-274 |
| `docs/Disney Vacation Planning, API Integration_.txt` | L177-185 |
| `src/lib/api/themeParks.ts` | L77-90 |
| `src/app/dashboard/parks/hollywood-studios/page.tsx` | L94-107 |
| `src/lib/data/parks.ts` | L14-67 |
| `src/types/api.ts` | L18-28 |
| `src/types/api.ts` | L43-62 |
| `docs/Disney Vacation Planning, API Integration_.txt` | L580-596 |
| `docs/Disney Vacation Planning, API Integration_.txt` | L274-313 |
| `src/app/api/parks/route.ts` | L14-67 |
| `src/app/api/parks/[parkId]/route.ts` | L36-66 |
| `src/components/attractions/types.ts` | L44-54 |
| `src/engines/itinerary/optimizer.ts` | L1-25 |
| `src/lib/api/themeParks.ts` | L63-77 |
| `src/app/dashboard/parks/epcot/page.tsx` | L82-118 |
| `src/types/attraction.ts` | L26-37 |
| `src/app/dashboard/parks/history/page.tsx` | L81-89 |
| `docs/Disney Vacation Planning, API Integration_.txt` | L223-233 |
| `docs/Disney Vacation Planning, API Integration_.txt` | L212-223 |
| `src/components/attractions/types.ts` | L1-7 |

</details>

---



---

I'll help you implement a comprehensive Magic Kingdom Park API integration using the themeparks.wiki API endpoints. Let me start by creating proper types and a complete API service.

---

```diff
- 
+ /**
+  * Complete type definitions for themeparks.wiki API
+  * Based on the Magic Kingdom Park API references
+  */
+ 
+ // Entity types enum
+ export enum EntityType {
+   DESTINATION = 'DESTINATION',
+   PARK = 'PARK',
+   ATTRACTION = 'ATTRACTION',
+   RESTAURANT = 'RESTAURANT',
+   SHOW = 'SHOW',
+   HOTEL = 'HOTEL'
+ }
+ 
+ // Base entity interface
+ export interface ThemeParksEntity {
+   id: string
+   name: string
+   slug: string | null
+   entityType: EntityType
+   parentId?: string
+   externalId?: string
+   location?: {
+     latitude: number
+     longitude: number
+   }
+ }
+ 
+ // Park-specific entity
+ export interface ThemeParksPark extends ThemeParksEntity {
+   entityType: EntityType.PARK
+   timezone: string
+   destinationId: string
+   location: {
+     latitude: number
+     longitude: number
+     pointsOfInterest: any[]
+   }
+ }
+ 
+ // Destination entity
+ export interface ThemeParksDestination extends ThemeParksEntity {
+   entityType: EntityType.DESTINATION
+   timezone: string
+   children?: ThemeParksEntity[]
+ }
+ 
+ // Live data types
+ export interface LiveDataItem {
+   id: string
+   name: string
+   entityType: EntityType
+   status: 'OPERATING' | 'CLOSED' | 'REFURBISHMENT' | 'DOWN'
+   queue?: {
+     STANDBY?: {
+       waitTime: number | null
+     }
+     RETURN_TIME?: {
+       state: 'AVAILABLE' | 'FINISHED'
+       returnStart?: string
+       returnEnd?: string
+     }
+     PAID_RETURN_TIME?: {
+       state: 'AVAILABLE' | 'FINISHED'
+       price?: {
+         amount: number
+         currency: string
+       }
+       returnStart?: string
+       returnEnd?: string
+     }
+   }
+   showtimes?: ShowTime[]
+   operatingHours?: OperatingHour[]
+   forecast?: any
+ }
+ 
+ export interface ShowTime {
+   startTime: string
+   endTime?: string
+   type: 'PERFORMANCE' | 'PARADE' | 'FIREWORKS'
+ }
+ 
+ export interface OperatingHour {
+   openingTime: string
+   closingTime: string
+   type?: 'OPERATING' | 'EXTRA_MAGIC' | 'SPECIAL_EVENT'
+ }
+ 
+ // Schedule types
+ export interface ScheduleEntry {
+   date: string
+   type: 'OPERATING' | 'EXTRA_MAGIC' | 'SPECIAL_EVENT' | 'TICKETED_EVENT'
+   openingTime: string
+   closingTime: string
+   specialHours?: {
+     type: string
+     openingTime: string
+     closingTime: string
+   }[]
+ }
+ 
+ // Full live data response
+ export interface LiveDataResponse {
+   id: string
+   name: string
+   entityType: EntityType
+   liveData: LiveDataItem[]
+   lastUpdate: string
+ }
+ 
+ // Schedule response
+ export interface ScheduleResponse {
+   id: string
+   name: string
+   entityType: EntityType
+   schedule: ScheduleEntry[]
+ }
+ 
+ // Children response (for attractions, restaurants, etc.)
+ export interface ChildrenResponse {
+   id: string
+   name: string
+   entityType: EntityType
+   timezone: string
+   children: ThemeParksEntity[]
+ }
+ 
+ // Park IDs mapping
+ export const PARK_IDS = {
+   MAGIC_KINGDOM: '75ea578a-adc8-4116-a54d-dccb60765ef9',
+   EPCOT: '47f90d2c-e191-4239-a466-5892ef59a88b',
+   HOLLYWOOD_STUDIOS: '288747d1-8b4f-4a64-867e-ea7c9b27bad8',
+   ANIMAL_KINGDOM: '1c84a229-8862-4648-9c71-378ddd2c7693',
+   WALT_DISNEY_WORLD_RESORT: 'e957da41-3552-4cf6-b636-5babc5cbc4e5'
+ } as const
+ 
+ export type ParkId = typeof PARK_IDS[keyof typeof PARK_IDS]
```

---



---

```diff
- 
+ /**
+  * ThemeParks.wiki API Service
+  * Comprehensive service for all themeparks.wiki API interactions
+  */
+ 
+ import { cache } from 'react'
+ import type {
+   ThemeParksPark,
+   ThemeParksDestination,
+   ThemeParksEntity,
+   LiveDataResponse,
+   ScheduleResponse,
+   ChildrenResponse,
+   PARK_IDS
+ } from '@/types/themeparks'
+ 
+ const BASE_URL = 'https://api.themeparks.wiki/v1'
+ 
+ // Cache configuration
+ const CACHE_TTL = {
+   entity: 3600, // 1 hour for static data
+   live: 60, // 1 minute for live data
+   schedule: 1800, // 30 minutes for schedule
+   children: 1800 // 30 minutes for children
+ }
+ 
+ // In-memory cache for runtime caching
+ const runtimeCache = new Map<string, { data: any; timestamp: number }>()
+ 
+ /**
+  * Enhanced fetch with caching and error handling
+  */
+ async function fetchWithCache<T>(
+   url: string,
+   ttl: number = CACHE_TTL.entity
+ ): Promise<T> {
+   const cacheKey = url
+   const cached = runtimeCache.get(cacheKey)
+ 
+   if (cached && Date.now() - cached.timestamp < ttl * 1000) {
+     return cached.data
+   }
+ 
+   try {
+     const response = await fetch(url, {
+       headers: {
+         'Content-Type': 'application/json',
+       },
+       next: { revalidate: ttl }
+     })
+ 
+     if (!response.ok) {
+       throw new Error(`API request failed: ${response.status} ${response.statusText}`)
+     }
+ 
+     const data = await response.json()
+ 
+     // Store in runtime cache
+     runtimeCache.set(cacheKey, { data, timestamp: Date.now() })
+ 
+     return data
+   } catch (error) {
+     console.error(`Error fetching from ${url}:`, error)
+ 
+     // Return cached data if available, even if expired
+     if (cached) {
+       console.warn('Returning stale cached data due to API error')
+       return cached.data
+     }
+ 
+     throw error
+   }
+ }
+ 
+ /**
+  * Get entity details (park, attraction, restaurant, etc.)
+  */
+ export const getEntity = cache(async (entityId: string): Promise<ThemeParksPark | ThemeParksEntity> => {
+   return fetchWithCache<ThemeParksPark | ThemeParksEntity>(
+     `${BASE_URL}/entity/${entityId}`,
+     CACHE_TTL.entity
+   )
+ })
+ 
+ /**
+  * Get live data for an entity (wait times, status, etc.)
+  */
+ export const getLiveData = async (entityId: string): Promise<LiveDataResponse> => {
+   return fetchWithCache<LiveDataResponse>(
+     `${BASE_URL}/entity/${entityId}/live`,
+     CACHE_TTL.live
+   )
+ }
+ 
+ /**
+  * Get children entities (attractions, restaurants, shows, etc.)
+  */
+ export const getChildren = cache(async (entityId: string): Promise<ChildrenResponse> => {
+   return fetchWithCache<ChildrenResponse>(
+     `${BASE_URL}/entity/${entityId}/children`,
+     CACHE_TTL.children
+   )
+ })
+ 
+ /**
+  * Get schedule for an entity
+  */
+ export const getSchedule = cache(async (
+   entityId: string,
+   year?: number,
+   month?: number
+ ): Promise<ScheduleResponse> => {
+   let url = `${BASE_URL}/entity/${entityId}/schedule`
+ 
+   if (year && month) {
+     url = `${url}/${year}/${String(month).padStart(2, '0')}`
+   }
+ 
+   return fetchWithCache<ScheduleResponse>(url, CACHE_TTL.schedule)
+ })
+ 
+ /**
+  * Get all destinations
+  */
+ export const getDestinations = cache(async (): Promise<ThemeParksDestination[]> => {
+   const response = await fetchWithCache<{ destinations: ThemeParksDestination[] }>(
+     `${BASE_URL}/destinations`,
+     CACHE_TTL.entity
+   )
+   return response.destinations || []
+ })
+ 
+ /**
+  * Get Disney destinations only
+  */
+ export const getDisneyDestinations = cache(async (): Promise<ThemeParksDestination[]> => {
+   const destinations = await getDestinations()
+   return destinations.filter(dest =>
+     dest.slug?.toLowerCase().includes('disney')
+   )
+ })
+ 
+ /**
+  * Get Magic Kingdom specific data
+  */
+ export const getMagicKingdom = cache(async () => {
+   return getEntity(PARK_IDS.MAGIC_KINGDOM) as Promise<ThemeParksPark>
+ })
+ 
+ /**
+  * Get Magic Kingdom live data
+  */
+ export const getMagicKingdomLive = async () => {
+   return getLiveData(PARK_IDS.MAGIC_KINGDOM)
+ }
+ 
+ /**
+  * Get Magic Kingdom attractions
+  */
+ export const getMagicKingdomAttractions = cache(async () => {
+   return getChildren(PARK_IDS.MAGIC_KINGDOM)
+ })
+ 
+ /**
+  * Get Magic Kingdom schedule
+  */
+ export const getMagicKingdomSchedule = cache(async (year?: number, month?: number) => {
+   return getSchedule(PARK_IDS.MAGIC_KINGDOM, year, month)
+ })
+ 
+ /**
+  * Get all Walt Disney World children (all parks, hotels, etc.)
+  */
+ export const getWaltDisneyWorldChildren = cache(async () => {
+   return getChildren(PARK_IDS.WALT_DISNEY_WORLD_RESORT)
+ })
+ 
+ /**
+  * Get Walt Disney World live data
+  */
+ export const getWaltDisneyWorldLive = async () => {
+   return getLiveData(PARK_IDS.WALT_DISNEY_WORLD_RESORT)
+ }
+ 
+ /**
+  * Get park by slug mapping
+  */
+ const SLUG_TO_ID_MAP: Record<string, string> = {
+   'magic-kingdom': PARK_IDS.MAGIC_KINGDOM,
+   'epcot': PARK_IDS.EPCOT,
+   'hollywood-studios': PARK_IDS.HOLLYWOOD_STUDIOS,
+   'animal-kingdom': PARK_IDS.ANIMAL_KINGDOM
+ }
+ 
+ export const getParkBySlug = cache(async (slug: string): Promise<ThemeParksPark> => {
+   const parkId = SLUG_TO_ID_MAP[slug]
+   if (!parkId) {
+     throw new Error(`Unknown park slug: ${slug}`)
+   }
+   return getEntity(parkId) as Promise<ThemeParksPark>
+ })
+ 
+ /**
+  * Get live data for park by slug
+  */
+ export const getParkLiveDataBySlug = async (slug: string) => {
+   const parkId = SLUG_TO_ID_MAP[slug]
+   if (!parkId) {
+     throw new Error(`Unknown park slug: ${slug}`)
+   }
+   return getLiveData(parkId)
+ }
+ 
+ /**
+  * Get attractions for park by slug
+  */
+ export const getParkAttractionsBySlug = cache(async (slug: string) => {
+   const parkId = SLUG_TO_ID_MAP[slug]
+   if (!parkId) {
+     throw new Error(`Unknown park slug: ${slug}`)
+   }
+   return getChildren(parkId)
+ })
+ 
+ /**
+  * Get schedule for park by slug
+  */
+ export const getParkScheduleBySlug = cache(async (
+   slug: string,
+   year?: number,
+   month?: number
+ ) => {
+   const parkId = SLUG_TO_ID_MAP[slug]
+   if (!parkId) {
+     throw new Error(`Unknown park slug: ${slug}`)
+   }
+   return getSchedule(parkId, year, month)
+ })
+ 
+ /**
+  * Clear runtime cache (useful for testing or forced refresh)
+  */
+ export function clearCache() {
+   runtimeCache.clear()
+ }
+ 
+ /**
+  * Get cache statistics
+  */
+ export function getCacheStats() {
+   const stats = {
+     size: runtimeCache.size,
+     entries: [] as Array<{ key: string; age: number }>
+   }
+ 
+   runtimeCache.forEach((value, key) => {
+     stats.entries.push({
+       key,
+       age: Math.floor((Date.now() - value.timestamp) / 1000)
+     })
+   })
+ 
+   return stats
+ }
```

---



---

```diff
  import { NextRequest, NextResponse } from 'next/server';
- import { cache } from 'react';
- 
- const BASE_URL = 'https://api.themeparks.wiki/v1';
- 
- // Mapping from internal park slugs to ThemeParks.wiki UUIDs
- const PARK_ID_MAPPINGS: Record<string, string> = {
-     'magic-kingdom': '75ea578a-adc8-4116-a54d-dccb60765ef9',
-     'epcot': '47f90d2c-e191-4239-a466-5892ef59a88b',
-     'hollywood-studios': '288747d1-8b4f-4a64-867e-ea7c9b27bad8',
-     'animal-kingdom': '1c84a229-8862-4648-9c71-378ddd2c7693',
-     'typhoon-lagoon': 'b070cbc5-feaa-4b87-a8c1-f94cca037a18',
-     'blizzard-beach': '8fe7ba5c-1a8e-4e6e-9d9e-8c8f8b8c8b8c'
- };
- 
- // Cache the fetch function
- const cachedFetch = cache(async (url: string) => {
-     const response = await fetch(url, {
-         headers: {
-             'Content-Type': 'application/json',
-         },
-         next: { revalidate: 300 }, // Cache for 5 minutes
-     });
- 
-     if (!response.ok) {
-         throw new Error(`API request failed: ${response.status}`);
-     }
- 
-     return response.json();
- });
+ import * as themeParksAPI from '@/lib/services/themeparks-api';
  
  interface RouteParams {
```

```diff
  }
  
- // GET handler for /api/parks/[parkId]
+ /**
+  * GET /api/parks/[parkId]
+  *
+  * Comprehensive park data endpoint supporting multiple data types
+  *
+  * Query parameters:
+  * - entity: 'details' | 'attractions' | 'live' | 'schedule' | 'showtimes'
+  * - year: YYYY (for schedule)
+  * - month: MM (for schedule)
+  */
  export async function GET(
      request: NextRequest,
```

```diff
          const { parkId } = await params;
          const searchParams = request.nextUrl.searchParams;
-         const entity = searchParams.get('entity');
+         const entity = searchParams.get('entity') || 'details';
  
-         // Map internal park ID to ThemeParks.wiki UUID
-         const themeParksId = PARK_ID_MAPPINGS[parkId];
-         if (!themeParksId) {
-             return NextResponse.json(
-                 {
-                     error: 'Park not found',
-                     availableParks: Object.keys(PARK_ID_MAPPINGS),
-                     requestedPark: parkId
-                 },
-                 { status: 404 }
-             );
-         }
- 
-         // Determine what data to fetch based on the 'entity' parameter
-         if (entity === 'attractions') {
-             const data = await cachedFetch(`${BASE_URL}/entity/${themeParksId}/children`);
-             // Return just the children array which contains the attractions
-             return NextResponse.json(data.children || []);
-         } else if (entity === 'live') {
-             const data = await cachedFetch(`${BASE_URL}/entity/${themeParksId}/live`);
-             // Return the liveData array which contains the attraction wait times
-             return NextResponse.json(data.liveData || []);
-         } else if (entity === 'schedule') {
-             const startDate = searchParams.get('startDate');
-             const endDate = searchParams.get('endDate');
- 
-             let url = `${BASE_URL}/entity/${themeParksId}/schedule`;
-             if (startDate && endDate) {
-                 url += `?startDate=${startDate}&endDate=${endDate}`;
-             }
- 
-             const data = await cachedFetch(url);
-             return NextResponse.json(data);
-         } else if (entity === 'showtimes') {
-             const date = searchParams.get('date');
- 
-             let url = `${BASE_URL}/entity/${themeParksId}/showtimes`;
-             if (date) {
-                 url += `?date=${date}`;
-             }
- 
-             const data = await cachedFetch(url);
-             return NextResponse.json(data);
-         } else {
-             // Default: return park details
-             const data = await cachedFetch(`${BASE_URL}/entity/${themeParksId}`);
-             return NextResponse.json(data);
+         // Handle different entity types
+         switch (entity) {
+             case 'details': {
+                 // Get park details
+                 const parkData = await themeParksAPI.getParkBySlug(parkId);
+                 return NextResponse.json(parkData);
+             }
+ 
+             case 'attractions': {
+                 // Get all children entities (attractions, restaurants, shows)
+                 const childrenData = await themeParksAPI.getParkAttractionsBySlug(parkId);
+                 return NextResponse.json(childrenData);
+             }
+ 
+             case 'live': {
+                 // Get live data (wait times, status)
+                 const liveData = await themeParksAPI.getParkLiveDataBySlug(parkId);
+                 return NextResponse.json(liveData);
+             }
+ 
+             case 'schedule': {
+                 // Get schedule with optional date range
+                 const year = searchParams.get('year');
+                 const month = searchParams.get('month');
+ 
+                 const scheduleData = await themeParksAPI.getParkScheduleBySlug(
+                     parkId,
+                     year ? parseInt(year) : undefined,
+                     month ? parseInt(month) : undefined
+                 );
+ 
+                 return NextResponse.json(scheduleData);
+             }
+ 
+             case 'showtimes': {
+                 // Get showtimes from live data
+                 const liveData = await themeParksAPI.getParkLiveDataBySlug(parkId);
+ 
+                 // Extract showtimes from live data
+                 const showtimes = liveData.liveData
+                     .filter(item => item.showtimes && item.showtimes.length > 0)
+                     .map(item => ({
+                         id: item.id,
+                         name: item.name,
+                         entityType: item.entityType,
+                         showtimes: item.showtimes
+                     }));
+ 
+                 return NextResponse.json({
+                     parkId,
+                     showtimes,
+                     lastUpdate: liveData.lastUpdate
+                 });
+             }
+ 
+             default: {
+                 return NextResponse.json(
+                     {
+                         error: 'Invalid entity type',
+                         validTypes: ['details', 'attractions', 'live', 'schedule', 'showtimes']
+                     },
+                     { status: 400 }
+                 );
+             }
          }
      } catch (error) {
          const { parkId } = await params;
          console.error(`Error fetching data for park ${parkId}:`, error);
+ 
+         if (error instanceof Error) {
+             if (error.message.includes('Unknown park slug')) {
+                 return NextResponse.json(
+                     {
+                         error: 'Park not found',
+                         message: error.message,
+                         availableParks: ['magic-kingdom', 'epcot', 'hollywood-studios', 'animal-kingdom']
+                     },
+                     { status: 404 }
+                 );
+             }
+         }
+ 
          return NextResponse.json(
-             { error: 'Failed to fetch park data' },
+             {
+                 error: 'Failed to fetch park data',
+                 message: error instanceof Error ? error.message : 'Unknown error'
+             },
              { status: 500 }
          );
```

---



---

```diff
  import { NextRequest, NextFetchEvent } from 'next/server';
  import { z } from 'zod';
- import { cache } from 'react';
  import { withEdge } from '../config';
  import { validateQuery } from '@/lib/api/validation';
  import { errorResponse, successResponse } from '@/lib/api/response';
- import { Destination } from '@/types/api';
+ import * as themeParksAPI from '@/lib/services/themeparks-api';
  
  // Define schema for query validation
  const ParksQuerySchema = z.object({
-     destination: z.string().optional()
+     destination: z.string().optional(),
+     includeChildren: z.boolean().optional().default(false)
  });
  
  export const runtime = 'edge';
  
- const BASE_URL = 'https://api.themeparks.wiki/v1';
- 
- // Cache the fetch function to reduce redundant API calls
- const cachedFetch = cache(async (url: string) => {
-     const response = await fetch(url, {
-         headers: {
-             'Content-Type': 'application/json',
-         },
-         next: { revalidate: 300 }, // Cache for 5 minutes
-     });
- 
-     if (!response.ok) {
-         throw new Error(`API request failed: ${response.status}`);
-     }
- 
-     return response.json();
- });
- 
- // GET handler for /api/parks
- // eslint-disable-next-line @typescript-eslint/no-unused-vars
+ /**
+  * GET /api/parks
+  *
+  * Returns Disney parks and destinations
+  *
+  * Query parameters:
+  * - destination: Filter by specific destination slug
+  * - includeChildren: Include child entities (parks, hotels, etc.)
+  */
  async function handleGet(request: NextRequest, _event: NextFetchEvent) {
      try {
```

```diff
          }
  
-         const { destination } = validation.data;
+         const { destination, includeChildren } = validation.data;
  
-         // If a specific destination is requested, return only that destination's parks
+         // If specific destination requested
          if (destination) {
-             const data = await cachedFetch(`${BASE_URL}/destination/${destination}/parks`);
-             return successResponse(data);
+             if (destination === 'walt-disney-world') {
+                 // Special handling for WDW
+                 if (includeChildren) {
+                     const children = await themeParksAPI.getWaltDisneyWorldChildren();
+                     return successResponse(children);
+                 } else {
+                     const wdwData = await themeParksAPI.getEntity(themeParksAPI.PARK_IDS.WALT_DISNEY_WORLD_RESORT);
+                     return successResponse(wdwData);
+                 }
              }
  
-         // Otherwise, return all Disney parks
-         const allDestinations = await cachedFetch(`${BASE_URL}/destinations`);
-         const disneyDestinations = (allDestinations as Destination[]).filter(
-             (dest: Destination) => dest.slug.includes('disney')
+             // Generic destination handling
+             const destinations = await themeParksAPI.getDisneyDestinations();
+             const found = destinations.find(dest => dest.slug === destination);
+ 
+             if (!found) {
+                 return errorResponse(
+                     'Destination not found',
+                     'NOT_FOUND',
+                     404
+                 );
+             }
+ 
+             return successResponse(found);
+         }
+ 
+         // Return all Disney destinations
+         const disneyDestinations = await themeParksAPI.getDisneyDestinations();
+ 
+         // Enhance with park count
+         const enhancedDestinations = await Promise.all(
+             disneyDestinations.map(async (dest) => {
+                 try {
+                     const children = await themeParksAPI.getChildren(dest.id);
+                     const parkCount = children.children.filter(
+                         child => child.entityType === 'PARK'
+                     ).length;
+ 
+                     return {
+                         ...dest,
+                         parkCount
+                     };
+                 } catch {
+                     // If we can't get children, just return the destination
+                     return dest;
+                 }
+             })
          );
  
-         return successResponse(disneyDestinations);
+         return successResponse(enhancedDestinations);
      } catch (error) {
          console.error('Error fetching parks data:', error);
```

---



---

```diff
  import { errorResponse, successResponse } from '@/lib/api/response';
  import * as themeParksAPI from '@/lib/services/themeparks-api';
+ import { PARK_IDS } from '@/types/themeparks';
  
  // Define schema for query validation
```

```diff
                      return successResponse(children);
                  } else {
-                     const wdwData = await themeParksAPI.getEntity(themeParksAPI.PARK_IDS.WALT_DISNEY_WORLD_RESORT);
+                     const wdwData = await themeParksAPI.getEntity(PARK_IDS.WALT_DISNEY_WORLD_RESORT);
                      return successResponse(wdwData);
                  }
```

---



---

```diff
- 
+ import { NextRequest } from 'next/server'
+ import { z } from 'zod'
+ import { withEdge } from '../../config'
+ import { validateQuery } from '@/lib/api/validation'
+ import { errorResponse, successResponse } from '@/lib/api/response'
+ import * as themeParksAPI from '@/lib/services/themeparks-api'
+ 
+ // Define schema for query validation
+ const MagicKingdomQuerySchema = z.object({
+   type: z.enum(['details', 'live', 'attractions', 'schedule']).optional().default('details'),
+   year: z.string().regex(/^\d{4}$/).optional(),
+   month: z.string().regex(/^\d{1,2}$/).optional()
+ })
+ 
+ export const runtime = 'edge'
+ 
+ /**
+  * GET /api/parks/magic-kingdom
+  *
+  * Get Magic Kingdom specific data
+  *
+  * Query parameters:
+  * - type: 'details' | 'live' | 'attractions' | 'schedule'
+  * - year: YYYY (for schedule)
+  * - month: MM (for schedule)
+  */
+ async function handleGet(request: NextRequest) {
+   try {
+     // Validate query parameters
+     const validation = await validateQuery(request, MagicKingdomQuerySchema)
+     if (!validation.success) {
+       return validation.error!
+     }
+ 
+     const { type, year, month } = validation.data
+ 
+     switch (type) {
+       case 'details': {
+         const parkData = await themeParksAPI.getMagicKingdom()
+         return successResponse(parkData)
+       }
+ 
+       case 'live': {
+         const liveData = await themeParksAPI.getMagicKingdomLive()
+         return successResponse(liveData)
+       }
+ 
+       case 'attractions': {
+         const attractionsData = await themeParksAPI.getMagicKingdomAttractions()
+         return successResponse(attractionsData)
+       }
+ 
+       case 'schedule': {
+         const scheduleData = await themeParksAPI.getMagicKingdomSchedule(
+           year ? parseInt(year) : undefined,
+           month ? parseInt(month) : undefined
+         )
+         return successResponse(scheduleData)
+       }
+ 
+       default: {
+         return errorResponse(
+           'Invalid type parameter',
+           'INVALID_TYPE',
+           400
+         )
+       }
+     }
+   } catch (error) {
+     console.error('Error fetching Magic Kingdom data:', error)
+     return errorResponse(
+       'Failed to fetch Magic Kingdom data',
+       'API_ERROR',
+       500
+     )
+   }
+ }
+ 
+ // Use the edge function wrapper with caching enabled
+ export const GET = withEdge(handleGet, {
+   cacheTtl: 60, // 1 minute for live data
+   edgeCaching: true
+ })
```

---



---

```diff
- 
+ import { NextRequest } from 'next/server'
+ import { z } from 'zod'
+ import { withEdge } from '../../config'
+ import { validateQuery } from '@/lib/api/validation'
+ import { errorResponse, successResponse } from '@/lib/api/response'
+ import * as themeParksAPI from '@/lib/services/themeparks-api'
+ 
+ // Define schema for query validation
+ const WaltDisneyWorldQuerySchema = z.object({
+   type: z.enum(['details', 'children', 'live']).optional().default('details')
+ })
+ 
+ export const runtime = 'edge'
+ 
+ /**
+  * GET /api/destinations/walt-disney-world
+  *
+  * Get Walt Disney World Resort data
+  *
+  * Query parameters:
+  * - type: 'details' | 'children' | 'live'
+  */
+ async function handleGet(request: NextRequest) {
+   try {
+     // Validate query parameters
+     const validation = await validateQuery(request, WaltDisneyWorldQuerySchema)
+     if (!validation.success) {
+       return validation.error!
+     }
+ 
+     const { type } = validation.data
+ 
+     switch (type) {
+       case 'details': {
+         const wdwData = await themeParksAPI.getEntity(themeParksAPI.PARK_IDS.WALT_DISNEY_WORLD_RESORT)
+         return successResponse(wdwData)
+       }
+ 
+       case 'children': {
+         const childrenData = await themeParksAPI.getWaltDisneyWorldChildren()
+ 
+         // Group children by entity type for better organization
+         const grouped = childrenData.children.reduce((acc, child) => {
+           const type = child.entityType || 'OTHER'
+           if (!acc[type]) acc[type] = []
+           acc[type].push(child)
+           return acc
+         }, {} as Record<string, typeof childrenData.children>)
+ 
+         return successResponse({
+           ...childrenData,
+           grouped,
+           summary: {
+             total: childrenData.children.length,
+             parks: grouped.PARK?.length || 0,
+             attractions: grouped.ATTRACTION?.length || 0,
+             restaurants: grouped.RESTAURANT?.length || 0,
+             shows: grouped.SHOW?.length || 0,
+             hotels: grouped.HOTEL?.length || 0
+           }
+         })
+       }
+ 
+       case 'live': {
+         const liveData = await themeParksAPI.getWaltDisneyWorldLive()
+         return successResponse(liveData)
+       }
+ 
+       default: {
+         return errorResponse(
+           'Invalid type parameter',
+           'INVALID_TYPE',
+           400
+         )
+       }
+     }
+   } catch (error) {
+     console.error('Error fetching Walt Disney World data:', error)
+     return errorResponse(
+       'Failed to fetch Walt Disney World data',
+       'API_ERROR',
+       500
+     )
+   }
+ }
+ 
+ // Use the edge function wrapper with caching enabled
+ export const GET = withEdge(handleGet, {
+   cacheTtl: 300, // 5 minutes
+   edgeCaching: true
+ })
```

---



---

```diff
  import { errorResponse, successResponse } from '@/lib/api/response'
  import * as themeParksAPI from '@/lib/services/themeparks-api'
+ import { PARK_IDS } from '@/types/themeparks'
  
  // Define schema for query validation
```

```diff
          switch (type) {
              case 'details': {
-                 const wdwData = await themeParksAPI.getEntity(themeParksAPI.PARK_IDS.WALT_DISNEY_WORLD_RESORT)
+                 const wdwData = await themeParksAPI.getEntity(PARK_IDS.WALT_DISNEY_WORLD_RESORT)
                  return successResponse(wdwData)
              }
```

---



---

Read file: src/lib/api/themeParks.ts

---



---

<details>
            <summary>Grep search for "from '@/lib/api/themeParks'" • **7** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/hooks/useWaitTimes.ts` | L1 | `import { getParkLiveData, getAttractionHistoricalData } from '@/lib/api/themeParks';` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/itinerary/optimizer.ts` | L1 | `import { getParkLiveData, getParkAttractions, getParkSchedule } from '@/lib/api/themeParks';` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/recommendation/index.ts` | L35 | `import { getParkAttractions, getParkLiveData } from '@/lib/api/themeParks'` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/components/itinerary/ItineraryPlanner.tsx` | L48 | `import { getWaltDisneyWorldParks } from '@/lib/api/themeParks';` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/components/parks/ParkExplorer.tsx` | L21 | `import { getWaltDisneyWorldParks, getParkAttractions } from '@/lib/api/themeParks';` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/components/parks/ParkMap.tsx` | L4 | `import { getPark } from '@/lib/api/themeParks';` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/components/dashboard/ParkDashboard.tsx` | L4 | `import { getWaltDisneyWorldParks, getParkSchedule } from '@/lib/api/themeParks';` |

</details>

---



---

<details>
            <summary>Grep search for "LiveData|ScheduleData|ShowtimeData|VirtualQueueData|LightningLaneData|HistoricalWaitTimeData" • **13** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/services/themeparks-api.ts` | L10 | `LiveDataResponse,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/services/themeparks-api.ts` | L87 | `export const getLiveData = async (entityId: string): Promise<LiveDataResponse> => {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/services/themeparks-api.ts` | L88 | `return fetchWithCache<LiveDataResponse>(` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/services/themeparks-api.ts` | L153 | `return getLiveData(PARK_IDS.MAGIC_KINGDOM)` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/services/themeparks-api.ts` | L181 | `return getLiveData(PARK_IDS.WALT_DISNEY_WORLD_RESORT)` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/services/themeparks-api.ts` | L205 | `export const getParkLiveDataBySlug = async (slug: string) => {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/services/themeparks-api.ts` | L210 | `return getLiveData(parkId)` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L6 | `LiveData,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L7 | `ScheduleData,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L8 | `ShowtimeData,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L9 | `VirtualQueueData,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L10 | `LightningLaneData,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L11 | `HistoricalWaitTimeData` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L117 | `export const getParkLiveData = async (parkId: string): Promise<LiveData> => {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L140 | `export const getParkSchedule = cache(async (parkId: string, startDate?: string, endDate?: string): Promise<ScheduleData> => {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L170 | `export const getParkShowtimes = cache(async (parkId: string, date?: string): Promise<ShowtimeData> => {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L179 | `const response = await apiClient.get<ShowtimeData>(url);` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L190 | `export const getVirtualQueueData = async (): Promise<VirtualQueueData> => {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L192 | `const response = await apiClient.get<VirtualQueueData>('/destination/waltdisneyworldresort/virtualqueues');` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L203 | `export const getLightningLaneData = async (): Promise<LightningLaneData> => {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L205 | `const response = await apiClient.get<LightningLaneData>('/destination/waltdisneyworldresort/genie');` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L216 | `export const getAttractionHistoricalData = cache(async (attractionId: string, startDate: string, endDate: string): Promise<HistoricalWaitTimeData[]> => {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L218 | `const response = await apiClient.get<HistoricalWaitTimeData[]>(`/attraction/${attractionId}/waittime?startDate=${startDate}&endDate=${endDate}`);` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L233 | `getParkLiveData,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L236 | `getVirtualQueueData,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/lib/api/themeParks.ts` | L237 | `getLightningLaneData,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L2 | `import { getParkLiveData } from "@/lib/api/themeParks";` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L474 | `async function transformLiveDataToAdvancedWaitTime(` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L476 | `liveData: Record<string, unknown>,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L481 | `const attractionsData = liveData.attractions && typeof liveData.attractions === 'object'` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L482 | `? liveData.attractions as Record<string, LiveAttractionData>` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L485 | `const attraction = attractionsData[attractionId] || liveData;` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L792 | `const liveData = await getParkLiveData(parkThemeParksId);` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L793 | `const transformedData = await transformLiveDataToAdvancedWaitTime(` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L795 | `liveData.attractions?.[attractionMapping.themeParksId] || {},` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L987 | `const liveData = await getParkLiveData(themeParksId);` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L989 | `if (!liveData.attractions) {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L1003 | `for (const [themeParksAttractionId, attractionData] of Object.entries(liveData.attractions)) {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/attractions/%5BattractionId%5D/wait-times/route.ts` | L1017 | `const transformedData = await transformLiveDataToAdvancedWaitTime(` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/%5BparkId%5D/route.ts` | L44 | `const liveData = await themeParksAPI.getParkLiveDataBySlug(parkId);` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/%5BparkId%5D/route.ts` | L45 | `return NextResponse.json(liveData);` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/%5BparkId%5D/route.ts` | L53 | `const scheduleData = await themeParksAPI.getParkScheduleBySlug(` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/%5BparkId%5D/route.ts` | L59 | `return NextResponse.json(scheduleData);` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/%5BparkId%5D/route.ts` | L64 | `const liveData = await themeParksAPI.getParkLiveDataBySlug(parkId);` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/%5BparkId%5D/route.ts` | L67 | `const showtimes = liveData.liveData` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/%5BparkId%5D/route.ts` | L79 | `lastUpdate: liveData.lastUpdate` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/magic-kingdom/route.ts` | L43 | `const liveData = await themeParksAPI.getMagicKingdomLive()` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/magic-kingdom/route.ts` | L44 | `return successResponse(liveData)` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/magic-kingdom/route.ts` | L53 | `const scheduleData = await themeParksAPI.getMagicKingdomSchedule(` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/parks/magic-kingdom/route.ts` | L57 | `return successResponse(scheduleData)` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/itinerary/optimizer.ts` | L1 | `import { getParkLiveData, getParkAttractions, getParkSchedule } from '@/lib/api/themeParks';` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/itinerary/optimizer.ts` | L4 | `LiveData,` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/itinerary/optimizer.ts` | L5 | `ScheduleData` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/itinerary/optimizer.ts` | L143 | `private liveData: LiveData | null = null;` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/itinerary/optimizer.ts` | L144 | `private schedule: ScheduleData | null = null;` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/itinerary/optimizer.ts` | L183 | `this.liveData = await getParkLiveData(this.parkId);` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/itinerary/optimizer.ts` | L190 | `const currentWaitTime = this.liveData?.attractions[attraction.id]?.waitTime?.standby || 0;` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/destinations/walt-disney-world/route.ts` | L65 | `const liveData = await themeParksAPI.getWaltDisneyWorldLive()` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/app/api/destinations/walt-disney-world/route.ts` | L66 | `return successResponse(liveData)` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/recommendation/index.ts` | L35 | `import { getParkAttractions, getParkLiveData } from '@/lib/api/themeParks'` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/recommendation/index.ts` | L195 | `const [attractions, liveData] = await Promise.all([` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/recommendation/index.ts` | L197 | `getParkLiveData(parkId)` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/engines/recommendation/index.ts` | L202 | `const live = liveData.attractions[attraction.id]` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/hooks/useWaitTimes.ts` | L1 | `import { getParkLiveData, getAttractionHistoricalData } from '@/lib/api/themeParks';` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/hooks/useWaitTimes.ts` | L2 | `import type { LiveData } from '@/types/api';` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/hooks/useWaitTimes.ts` | L17 | `liveWaitTimes: LiveData | undefined;` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/hooks/useWaitTimes.ts` | L64 | `} = useQuery<LiveData, Error>({ // Explicitly type the query data and error` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/hooks/useWaitTimes.ts` | L66 | `queryFn: () => getParkLiveData(parkId),` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/types/themeparks.ts` | L49 | `export interface LiveDataItem {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/types/themeparks.ts` | L104 | `export interface LiveDataResponse {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/types/themeparks.ts` | L108 | `liveData: LiveDataItem[]` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/components/parks/AttractionCard.tsx` | L25 | `import { Attraction, AttractionStatus, LiveData } from '@/types/api';` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/components/parks/AttractionCard.tsx` | L30 | `readonly waitTimeData?: LiveData['attractions'][string];` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/types/api.ts` | L153 | `export interface LiveData {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/types/api.ts` | L166 | `export interface ScheduleData {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/types/api.ts` | L177 | `export interface ShowtimeData {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/types/api.ts` | L190 | `export interface VirtualQueueData {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/types/api.ts` | L208 | `export interface LightningLaneData {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/types/api.ts` | L329 | `export interface HistoricalWaitTimeData {` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/docs/Disney%20Vacation%20Planning%2C%20API%20Integration_.txt` | L177 | `⟪ 247 characters skipped ⟫E, PriceData, DiningAvailability, EntityLiveData) will serve as a reference for manually defining the necessary TypeScript interfaces and types for API responses. This is a less ideal but viable alternative.` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/docs/Disney%20Vacation%20Planning%2C%20API%20Integration_.txt` | L191 | `* EntityLiveDataResponse & EntityLiveData: The wrapper and core object for real-time data. EntityLiveData typically includes:` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/docs/Disney%20Vacation%20Planning%2C%20API%20Integration_.txt` | L221 | `* Displaying Magic Kingdom Wait Times: Fetch entityID for Magic Kingdom -> Call GET /entity/{magicKingdomEntityID}/live -> Parse EntityLiveDataResponse -> For each child attraction entity, extract name and wait from LiveQueueSTANDBY.` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/docs/Disney%20Vacation%20Planning%2C%20API%20Integration_.txt` | L222 | `* Showing ILL Price for TRON Lightcycle / Run: Fetch entityID for TRON -> Call GET /entity/{tronEntityID}/live -> Parse EntityLiveDataResponse -> Extract price from PriceData associated with LiveQueuePAIDRETURNTIME.` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/docs/Disney%20Vacation%20Planning%2C%20API%20Integration_.txt` | L251 | `EntityLiveData, LiveQueueSTANDBY` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/docs/Disney%20Vacation%20Planning%2C%20API%20Integration_.txt` | L258 | `EntityLiveData, LiveQueuePAIDRETURNTIME (or LiveQueueRETURNTIME if Genie+ uses a different structure)` |

</details>

---



---

```diff
- 
+ /**
+  * Compatibility layer for migrating from old themeParks.ts to new themeparks-api.ts
+  * This provides the same interface as the old module but uses the new API service
+  */
+ 
+ import * as themeParksAPI from '@/lib/services/themeparks-api'
+ import type {
+   Destination,
+   Park,
+   Attraction,
+   LiveData,
+   ScheduleData
+ } from '@/types/api'
+ import type {
+   LiveDataResponse,
+   ScheduleResponse,
+   ThemeParksEntity,
+   ThemeParksPark,
+   ChildrenResponse
+ } from '@/types/themeparks'
+ 
+ /**
+  * Convert new LiveDataResponse to old LiveData format
+  */
+ function convertLiveData(response: LiveDataResponse): LiveData {
+   const attractions: LiveData['attractions'] = {}
+ 
+   response.liveData.forEach(item => {
+     if (item.entityType === 'ATTRACTION') {
+       attractions[item.id] = {
+         id: item.id,
+         name: item.name,
+         status: item.status || 'CLOSED',
+         waitTime: {
+           standby: item.queue?.STANDBY?.waitTime ?? null,
+           returnTime: item.queue?.RETURN_TIME ? {
+             state: item.queue.RETURN_TIME.state,
+             returnStart: item.queue.RETURN_TIME.returnStart,
+             returnEnd: item.queue.RETURN_TIME.returnEnd
+           } : undefined,
+           paidReturnTime: item.queue?.PAID_RETURN_TIME ? {
+             state: item.queue.PAID_RETURN_TIME.state,
+             price: item.queue.PAID_RETURN_TIME.price,
+             returnStart: item.queue.PAID_RETURN_TIME.returnStart,
+             returnEnd: item.queue.PAID_RETURN_TIME.returnEnd
+           } : undefined
+         },
+         lastUpdate: response.lastUpdate
+       }
+     }
+   })
+ 
+   return {
+     attractions,
+     lastUpdate: response.lastUpdate,
+     parkId: response.id
+   }
+ }
+ 
+ /**
+  * Convert new ScheduleResponse to old ScheduleData format
+  */
+ function convertScheduleData(response: ScheduleResponse): ScheduleData {
+   return {
+     parkId: response.id,
+     schedule: response.schedule.map(entry => ({
+       date: entry.date,
+       openingTime: entry.openingTime,
+       closingTime: entry.closingTime,
+       type: entry.type,
+       specialHours: entry.specialHours
+     }))
+   }
+ }
+ 
+ /**
+  * Convert ThemeParksEntity to Attraction
+  */
+ function convertToAttraction(entity: ThemeParksEntity): Attraction {
+   return {
+     id: entity.id,
+     name: entity.name,
+     slug: entity.slug || '',
+     entityType: 'ATTRACTION',
+     parkId: entity.parentId || '',
+     attractionType: 'RIDE', // Default, as the new API doesn't provide this
+     location: entity.location,
+     status: 'OPERATING' // Default status
+   }
+ }
+ 
+ /**
+  * Get Disney destinations (compatibility function)
+  */
+ export const getDisneyDestinations = async (): Promise<Destination[]> => {
+   const destinations = await themeParksAPI.getDisneyDestinations()
+   return destinations.map(dest => ({
+     ...dest,
+     parks: [] // Parks would need to be fetched separately
+   })) as unknown as Destination[]
+ }
+ 
+ /**
+  * Get Walt Disney World parks (compatibility function)
+  */
+ export const getWaltDisneyWorldParks = async (): Promise<Park[]> => {
+   const children = await themeParksAPI.getWaltDisneyWorldChildren()
+   return children.children
+     .filter(child => child.entityType === 'PARK')
+     .map(park => ({
+       ...park,
+       destination: park.parentId || '',
+       timezone: 'America/New_York'
+     })) as unknown as Park[]
+ }
+ 
+ /**
+  * Get park attractions (compatibility function)
+  */
+ export const getParkAttractions = async (parkId: string): Promise<Attraction[]> => {
+   const children = await themeParksAPI.getParkAttractionsBySlug(parkId)
+   return children.children
+     .filter(child => child.entityType === 'ATTRACTION')
+     .map(convertToAttraction)
+ }
+ 
+ /**
+  * Get park live data (compatibility function)
+  */
+ export const getParkLiveData = async (parkId: string): Promise<LiveData> => {
+   const liveData = await themeParksAPI.getParkLiveDataBySlug(parkId)
+   return convertLiveData(liveData)
+ }
+ 
+ /**
+  * Get park schedule (compatibility function)
+  */
+ export const getParkSchedule = async (
+   parkId: string,
+   startDate?: string,
+   endDate?: string
+ ): Promise<ScheduleData> => {
+   // Parse dates if provided
+   let year: number | undefined
+   let month: number | undefined
+ 
+   if (startDate) {
+     const date = new Date(startDate)
+     year = date.getFullYear()
+     month = date.getMonth() + 1
+   }
+ 
+   const schedule = await themeParksAPI.getParkScheduleBySlug(parkId, year, month)
+   return convertScheduleData(schedule)
+ }
+ 
+ /**
+  * Get park details (compatibility function)
+  */
+ export const getPark = async (parkId: string): Promise<Park> => {
+   const park = await themeParksAPI.getParkBySlug(parkId) as ThemeParksPark
+   return {
+     ...park,
+     destination: park.destinationId
+   } as unknown as Park
+ }
+ 
+ /**
+  * Get attraction historical data (stub - not available in new API)
+  */
+ export const getAttractionHistoricalData = async (
+   attractionId: string,
+   startDate: string,
+   endDate: string
+ ): Promise<any[]> => {
+   console.warn('Historical data not available in new API')
+   return []
+ }
+ 
+ // Default export for compatibility
+ export default {
+   getDisneyDestinations,
+   getWaltDisneyWorldParks,
+   getPark,
+   getParkAttractions,
+   getParkLiveData,
+   getParkSchedule,
+   getAttractionHistoricalData
+ }
```

---



---

Remove the old themeParks API client as it's replaced by the new themeparks-api service

---



---

```diff
  import { useQuery } from '@tanstack/react-query';
- import { getParkLiveData, getAttractionHistoricalData } from '@/lib/api/themeParks';
+ import { getParkLiveData, getAttractionHistoricalData } from '@/lib/api/themeParks-compat';
  import type { LiveData } from '@/types/api';
  import { useState, useMemo, useEffect } from 'react';
```

---



---

```diff
  // src/engines/itinerary/optimizer.ts
- import { getParkLiveData, getParkAttractions, getParkSchedule } from '@/lib/api/themeParks';
+ import { getParkLiveData, getParkAttractions, getParkSchedule } from '@/lib/api/themeParks-compat';
  import type {
      Attraction,
```

---



---

```diff
   */
  
- import { getParkAttractions, getParkLiveData } from '@/lib/api/themeParks'
+ import { Supabase } from '@/lib/supabase/client'
+ import { getParkAttractions, getParkLiveData } from '@/lib/api/themeParks-compat'
+ import type { Database } from '@/types/database'
  import type {
      Attraction,
```

---



---

Read file: src/engines/recommendation/index.ts

---



---

```diff
   */
  
- import { Supabase } from '@/lib/supabase/client'
  import { getParkAttractions, getParkLiveData } from '@/lib/api/themeParks-compat'
- import type { Database } from '@/types/database'
  import type {
      Attraction,
```

---



---

```diff
      CheckIcon
  } from 'lucide-react';
- import { getWaltDisneyWorldParks } from '@/lib/api/themeParks';
+ import { getWaltDisneyWorldParks } from '@/lib/api/themeParks-compat';
  import { useItineraryOptimizer } from '@/engines/itinerary/optimizer';
- import { Park } from '@/types/api';
+ import { Park, AttractionType } from '@/types/api';
+ import type { Coordinates } from '@/types/api';
  
  dayjs.extend(advancedFormat);
```

---



---

```diff
  import { Label } from "@/components/ui/label";
  import { AlertCircle, Clock, Filter, Map as MapIcon, RefreshCw } from "lucide-react";
- import { getWaltDisneyWorldParks, getParkAttractions } from '@/lib/api/themeParks';
+ import { getWaltDisneyWorldParks, getParkAttractions } from '@/lib/api/themeParks-compat';
  import { Attraction, AttractionType, AttractionStatus } from '@/types/api';
  import { useWaitTimes } from '@/hooks/useWaitTimes';
```

---



---

```diff
+ 'use client';
+ 
  import { useState, useMemo, useEffect, useRef, useCallback } from 'react';
  import { useQuery } from '@tanstack/react-query';
  import { MapContainer, TileLayer, Marker, Popup, Circle, useMapEvents } from 'react-leaflet';
  import L from 'leaflet';
- import { getPark } from '@/lib/api/themeParks';
+ import { getPark } from '@/lib/api/themeParks-compat';
  import type { Attraction, Coordinates } from '@/types/api';
  import {
```

---



---

```diff
+ 'use client'
+ 
  // src/components/dashboard/ParkDashboard.tsx
  import { useState, useEffect } from 'react';
  import { useQuery } from '@tanstack/react-query';
  import { format, parseISO, isSameDay } from 'date-fns';
- import { getWaltDisneyWorldParks, getParkSchedule } from '@/lib/api/themeParks';
+ import { getWaltDisneyWorldParks, getParkSchedule } from '@/lib/api/themeParks-compat';
  import { useWaitTimes } from '@/hooks/useWaitTimes';
  import {
```

---



---

Read file: src/app/api/attractions/[attractionId]/wait-times/route.ts

---



---

```diff
  import { NextResponse } from "next/server";
  import { getCurrentWaitTimes, predictWaitTime } from "@/engines/waitTimes";
- import { getParkLiveData } from "@/lib/api/themeParks";
+ import { getParkLiveData } from "@/lib/api/themeParks-compat";
  import { createClient } from "@supabase/supabase-js";
  
```

---



---

```diff
- 
+ # ThemeParks.wiki API Integration
+ 
+ This document outlines the comprehensive integration with the themeparks.wiki API for Disney park data.
+ 
+ ## Overview
+ 
+ The themeparks.wiki API provides real-time and static data for Disney parks, including:
+ - Park information and operating hours
+ - Attraction details and wait times
+ - Restaurant and show information
+ - Live status updates
+ 
+ ## API Endpoints
+ 
+ ### Parks
+ 
+ #### Get All Parks
+ ```
+ GET /api/parks
+ ```
+ 
+ Query Parameters:
+ - `destination` (optional): Filter by destination slug (e.g., "walt-disney-world")
+ - `includeChildren` (optional): Include child entities (default: false)
+ 
+ #### Get Park Details
+ ```
+ GET /api/parks/[parkId]
+ ```
+ 
+ Path Parameters:
+ - `parkId`: Park slug (magic-kingdom, epcot, hollywood-studios, animal-kingdom)
+ 
+ Query Parameters:
+ - `entity`: Data type to fetch
+   - `details`: Park information (default)
+   - `attractions`: All attractions, restaurants, and shows
+   - `live`: Live wait times and status
+   - `schedule`: Operating hours
+   - `showtimes`: Show times
+ 
+ Example:
+ ```
+ GET /api/parks/magic-kingdom?entity=live
+ ```
+ 
+ ### Magic Kingdom Specific
+ 
+ #### Get Magic Kingdom Data
+ ```
+ GET /api/parks/magic-kingdom
+ ```
+ 
+ Query Parameters:
+ - `type`: Data type (details, live, attractions, schedule)
+ - `year`: Year for schedule (YYYY)
+ - `month`: Month for schedule (MM)
+ 
+ Example:
+ ```
+ GET /api/parks/magic-kingdom?type=schedule&year=2025&month=5
+ ```
+ 
+ ### Destinations
+ 
+ #### Get Walt Disney World Data
+ ```
+ GET /api/destinations/walt-disney-world
+ ```
+ 
+ Query Parameters:
+ - `type`: Data type (details, children, live)
+ 
+ ## Data Types
+ 
+ ### ThemeParksEntity
+ ```typescript
+ interface ThemeParksEntity {
+   id: string
+   name: string
+   slug: string | null
+   entityType: 'PARK' | 'ATTRACTION' | 'RESTAURANT' | 'SHOW' | 'HOTEL'
+   parentId?: string
+   externalId?: string
+   location?: {
+     latitude: number
+     longitude: number
+   }
+ }
+ ```
+ 
+ ### LiveDataItem
+ ```typescript
+ interface LiveDataItem {
+   id: string
+   name: string
+   entityType: string
+   status: 'OPERATING' | 'CLOSED' | 'REFURBISHMENT' | 'DOWN'
+   queue?: {
+     STANDBY?: {
+       waitTime: number | null
+     }
+     RETURN_TIME?: {
+       state: 'AVAILABLE' | 'FINISHED'
+       returnStart?: string
+       returnEnd?: string
+     }
+     PAID_RETURN_TIME?: {
+       state: 'AVAILABLE' | 'FINISHED'
+       price?: {
+         amount: number
+         currency: string
+       }
+       returnStart?: string
+       returnEnd?: string
+     }
+   }
+   showtimes?: ShowTime[]
+   operatingHours?: OperatingHour[]
+ }
+ ```
+ 
+ ### ScheduleEntry
+ ```typescript
+ interface ScheduleEntry {
+   date: string
+   type: 'OPERATING' | 'EXTRA_MAGIC' | 'SPECIAL_EVENT' | 'TICKETED_EVENT'
+   openingTime: string
+   closingTime: string
+   specialHours?: {
+     type: string
+     openingTime: string
+     closingTime: string
+   }[]
+ }
+ ```
+ 
+ ## Service Layer
+ 
+ The themeparks API service (`src/lib/services/themeparks-api.ts`) provides:
+ 
+ ### Core Functions
+ 
+ - `getEntity(entityId)`: Get any entity by ID
+ - `getLiveData(entityId)`: Get live data for an entity
+ - `getChildren(entityId)`: Get child entities
+ - `getSchedule(entityId, year?, month?)`: Get schedule
+ 
+ ### Magic Kingdom Functions
+ 
+ - `getMagicKingdom()`: Get park details
+ - `getMagicKingdomLive()`: Get live data
+ - `getMagicKingdomAttractions()`: Get all attractions
+ - `getMagicKingdomSchedule(year?, month?)`: Get schedule
+ 
+ ### Park Functions by Slug
+ 
+ - `getParkBySlug(slug)`: Get park details
+ - `getParkLiveDataBySlug(slug)`: Get live data
+ - `getParkAttractionsBySlug(slug)`: Get attractions
+ - `getParkScheduleBySlug(slug, year?, month?)`: Get schedule
+ 
+ ## Caching Strategy
+ 
+ The API implements multiple caching layers:
+ 
+ 1. **Runtime Cache**: In-memory cache with configurable TTLs
+    - Entity data: 1 hour
+    - Live data: 1 minute
+    - Schedule: 30 minutes
+    - Children: 30 minutes
+ 
+ 2. **Next.js Cache**: Server-side caching via `next: { revalidate }`
+ 
+ 3. **Edge Caching**: For API routes with `withEdge` wrapper
+ 
+ ## Error Handling
+ 
+ All API calls include:
+ - Graceful fallback to cached data on error
+ - Proper error status codes
+ - Detailed error messages
+ - Retry logic for transient failures
+ 
+ ## Rate Limiting
+ 
+ The themeparks.wiki API has a rate limit of 300 requests per minute per IP. Our implementation:
+ - Uses server-side caching to minimize requests
+ - Returns cached data when possible
+ - Implements proper error handling for rate limit errors
+ 
+ ## Migration from Old API
+ 
+ A compatibility layer (`src/lib/api/themeParks-compat.ts`) is provided for smooth migration:
+ 
+ ```typescript
+ // Old import
+ import { getParkLiveData } from '@/lib/api/themeParks'
+ 
+ // New import (using compatibility layer)
+ import { getParkLiveData } from '@/lib/api/themeParks-compat'
+ ```
+ 
+ The compatibility layer maintains the same interface while using the new API service internally.
+ 
+ ## Examples
+ 
+ ### Get Magic Kingdom Live Data
+ ```javascript
+ const response = await fetch('/api/parks/magic-kingdom?entity=live')
+ const data = await response.json()
+ 
+ // Response includes:
+ // - Current wait times for all attractions
+ // - Operating status
+ // - Lightning Lane availability
+ // - Show times
+ ```
+ 
+ ### Get Park Schedule for May 2025
+ ```javascript
+ const response = await fetch('/api/parks/magic-kingdom?type=schedule&year=2025&month=5')
+ const data = await response.json()
+ 
+ // Response includes daily operating hours for the month
+ ```
+ 
+ ### Get All Walt Disney World Parks
+ ```javascript
+ const response = await fetch('/api/destinations/walt-disney-world?type=children')
+ const data = await response.json()
+ 
+ // Response includes all parks, hotels, and other entities
+ // Grouped by type for easy access
+ ```
```

---



---

Cancelled

---

