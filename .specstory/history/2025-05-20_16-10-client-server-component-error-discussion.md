<!-- Generated by SpecStory -->

# Client-Server Component Error Discussion (2025-05-20 11:10:59)

_**User**_

Error: Only plain objects, and a few built-ins, can be passed to Client Components from Server Components. Classes or null prototypes are not supported.
  <... client={{}} children={{...}}>
              ^^^^
    at resolveErrorDev (http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_2ce9398a._.js:17582:48)
    at processFullStringRow (http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_2ce9398a._.js:17798:23)
    at processFullBinaryRow (http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_2ce9398a._.js:17786:9)
    at progress (http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_2ce9398a._.js:17932:102)
    at InnerLayoutRouter (http://localhost:3000/_next/static/chunks/node_modules_next_dist_1a6ee436._.js:356:55)
    at OuterLayoutRouter (http://localhost:3000/_next/static/chunks/node_modules_next_dist_1a6ee436._.js:504:73)

Error: Only plain objects, and a few built-ins, can be passed to Client Components from Server Components. Classes or null prototypes are not supported.
  <... client={{}} children={{...}}>
              ^^^^
    at resolveErrorDev (http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_2ce9398a._.js:17582:48)
    at processFullStringRow (http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_2ce9398a._.js:17798:23)
    at processFullBinaryRow (http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_2ce9398a._.js:17786:9)
    at progress (http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_2ce9398a._.js:17932:102)
    at ErrorBoundaryHandler.render (http://localhost:3000/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1595:55)
    at ErrorBoundary (http://localhost:3000/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1666:50)
    at OuterLayoutRouter (http://localhost:3000/_next/static/chunks/node_modules_next_dist_1a6ee436._.js:493:57)

---

_**Assistant**_



---

Read file: src/app/map/page.tsx

---



---

Read file: src/app/map/layout.tsx

---



---

```diff
- 
+ 'use client'
+ 
+ import { ReactNode, useState } from 'react'
+ import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
+ 
+ interface ReactQueryProviderProps {
+   readonly children: ReactNode
+ }
+ 
+ /**
+  * ReactQueryProvider
+  * Wraps its children with TanStack QueryClientProvider.
+  * QueryClient must be created inside a Client Component to avoid
+  * serialization errors when used within Server Components.
+  */
+ export default function ReactQueryProvider({ children }: ReactQueryProviderProps) {
+   // Create the client once per provider instance
+   const [queryClient] = useState(() => new QueryClient())
+ 
+   return <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
+ }
```

---



---

```diff
  import type { Metadata } from "next";
  import MapProvider from "@/providers/map-provider";
+ import ReactQueryProvider from "@/providers/react-query-provider";
  import { Toaster } from "@/components/ui/toaster";
- import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
  
  export const metadata: Metadata = {
```

```diff
  
  export default function MapLayout({ children }: MapLayoutProps) {
-     const queryClient = new QueryClient();
- 
      return (
-         <QueryClientProvider client={queryClient}>
+         <ReactQueryProvider>
              <MapProvider>
                  <div className="relative min-h-screen">
```

```diff
                  </div>
              </MapProvider>
-         </QueryClientProvider>
+         </ReactQueryProvider>
      );
  }
```

---



---

<details>
            <summary>Grep search for "QueryClientProvider" • **1** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/providers/react-query-provider.tsx` | L3 | `import { QueryClient, QueryClientProvider } from '@tanstack/react-query'` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/providers/react-query-provider.tsx` | L11 | `* Wraps its children with TanStack QueryClientProvider.` |
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/providers/react-query-provider.tsx` | L19 | `return <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>` |

</details>

---



---

<details>
            <summary>Grep search for "new QueryClient(" • **1** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/williamcarrico/Web%20App%20Design/woody-disney-vacation-planning/src/providers/react-query-provider.tsx` | L17 | `const [queryClient] = useState(() => new QueryClient())` |

</details>

---



---

Root-cause  
`QueryClient` is a class instance.  
The server-side layout file `src/app/map/layout.tsx` was creating a new `QueryClient` and passing it to the **client** component `QueryClientProvider`.  
Because anything handed from a Server Component to a Client Component must be JSON-serialisable, React (and therefore Next.js) threw:

```
Only plain objects, and a few built-ins, can be passed to Client Components …
  <… client={{}} …>
```

(the prop that triggered it is the `client` prop of `QueryClientProvider`).

Fix implemented  
1. Added a tiny client-only wrapper that instantiates `QueryClient` on the browser instead of the server:

`src/providers/react-query-provider.tsx`
```tsx
'use client'

import { ReactNode, useState } from 'react'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'

export default function ReactQueryProvider({ children }: { children: ReactNode }) {
  // make sure the same instance is reused on every render
  const [client] = useState(() => new QueryClient())

  return <QueryClientProvider client={client}>{children}</QueryClientProvider>
}
```

2. Refactored the server layout `src/app/map/layout.tsx` to use that wrapper instead of instantiating `QueryClient` directly:

```diff
-import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
+import ReactQueryProvider from '@/providers/react-query-provider'

-const queryClient = new QueryClient();
-<QueryClientProvider client={queryClient}>
+<ReactQueryProvider>
   <MapProvider>
     …
   </MapProvider>
-</QueryClientProvider>
+</ReactQueryProvider>
```

Now the server layout no longer passes a class instance across the server-to-client boundary, eliminating the serialization error.

You can start the dev server again (`npm run dev`) and the map route should load without the “Only plain objects…” exception.

---

_**User**_

Error: Google Maps JavaScript API error: InvalidKeyMapError
https://developers.google.com/maps/documentation/javascript/error-messages#invalid-key-map-error
    at createConsoleError (http://localhost:3000/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:882:71)
    at handleConsoleError (http://localhost:3000/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1058:54)
    at console.error (http://localhost:3000/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1223:57)
    at _.ij (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:145:425)
    at HAa (https://maps.googleapis.com/maps-api-v3/api/js/60/12/map.js:48:400)
    at EAa (https://maps.googleapis.com/maps-api-v3/api/js/60/12/map.js:47:146)
    at FAa (https://maps.googleapis.com/maps-api-v3/api/js/60/12/map.js:45:493)

TypeError: Cannot read properties of undefined (reading 'getRootNode')
    at _.Dk (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:165:41)
    at set map (https://maps.googleapis.com/maps-api-v3/api/js/60/12/marker.js:124:15)
    at useAdvancedMarker.useEffect (http://localhost:3000/_next/static/chunks/node_modules_639154db._.js:16194:35)

TypeError: Cannot read properties of undefined (reading 'getRootNode')
    at _.Dk (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:165:41)
    at set map (https://maps.googleapis.com/maps-api-v3/api/js/60/12/marker.js:124:15)
    at useAdvancedMarker.useEffect (http://localhost:3000/_next/static/chunks/node_modules_639154db._.js:16194:35)
    at ErrorBoundaryHandler.render (http://localhost:3000/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1595:55)
    at ErrorBoundary (http://localhost:3000/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1666:50)
    at OuterLayoutRouter (http://localhost:3000/_next/static/chunks/node_modules_next_dist_1a6ee436._.js:493:57)


---

_**Assistant**_



---

What’s happening  
`InvalidKeyMapError` means the Google Maps JavaScript SDK is loading, but rejects the request because the `key` query-string value it receives is either:  

1. Missing or mistyped (empty string)  
2. Disabled or not enabled for “Maps JavaScript API”  
3. Restricted to referrers that don’t include `http://localhost:3000`  
4. Belongs to a project that has no active billing account  

Because the SDK aborts early, `map` is never created, so `AdvancedMarker` later throws the secondary `TypeError: … getRootNode`.

Checklist to resolve

1. Create / locate a valid key  
   • In Google Cloud console → “APIs & Services → Credentials”  
   • Key type: unrestricted **server** key is fine for local testing, or a browser-restricted key with `http://localhost:3000/*` added to HTTP referrers.  
   • Make sure “Maps JavaScript API” (and optionally “Places API” if you search) is **enabled** for the same project.  
   • Verify project has an active billing account.

2. Put the key where the client can see it  
   Next.js exposes env-vars only if they start with `NEXT_PUBLIC_`.  
   Add / update `.env.local` (not committed) in the project root:

   ```
   NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=AIzaSy••••••••••••
   # optional – only if you use a styled map created in Google Cloud
   NEXT_PUBLIC_GOOGLE_MAPS_MAP_ID=your-map-id
   ```

3. Restart the dev server  
   Next has to rebuild so the env-vars are inlined:

   ```bash
   npm run dev   # or yarn dev / pnpm dev
   ```

4. Hard-refresh the browser (⌘⇧R / Ctrl-Shift-R).  
   Open DevTools → Network, filter for `maps/api/js`, verify the request URL now contains `key=AIza…`.

5. If you still get `InvalidKeyMapError`  
   • Copy that exact request URL, paste in a new tab; confirm the same error shows in plain JSON – that isolates issues away from your app.  
   • Double-check referrer restrictions and billing in Cloud console.  
   • If you see `RefererNotAllowedMapError`, add your origin (`http://localhost:3000/*`) to the key’s referrer list.  
   • If you see `ApiNotActivatedMapError`, enable the “Maps JavaScript API” for the key’s project.  
   • Google’s official error table explains each code in detail [docs](https://developers.google.com/maps/documentation/javascript/error-messages#invalid-key-map-error).

Once the key is accepted the map loads, and `AdvancedMarker` no longer encounters `getRootNode` because `map` is defined.

---

_**User**_

Error: Google Maps JavaScript API error: InvalidKeyMapError
https://developers.google.com/maps/documentation/javascript/error-messages#invalid-key-map-error
    at createConsoleError (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:882:71)
    at handleConsoleError (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1058:54)
    at console.error (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1223:57)
    at _.ij (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:145:425)
    at HAa (https://maps.googleapis.com/maps-api-v3/api/js/60/12/map.js:48:400)
    at EAa (https://maps.googleapis.com/maps-api-v3/api/js/60/12/map.js:47:146)
    at FAa (https://maps.googleapis.com/maps-api-v3/api/js/60/12/map.js:45:493)

TypeError: Cannot read properties of undefined (reading 'getRootNode')
    at _.Dk (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:165:41)
    at set map (https://maps.googleapis.com/maps-api-v3/api/js/60/12/marker.js:124:15)
    at useAdvancedMarker.useEffect (http://localhost:3001/_next/static/chunks/node_modules_639154db._.js:16194:35)

TypeError: Cannot read properties of undefined (reading 'getRootNode')
    at _.Dk (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:165:41)
    at set map (https://maps.googleapis.com/maps-api-v3/api/js/60/12/marker.js:124:15)
    at useAdvancedMarker.useEffect (http://localhost:3001/_next/static/chunks/node_modules_639154db._.js:16194:35)
    at ErrorBoundaryHandler.render (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1595:55)
    at ErrorBoundary (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1666:50)
    at OuterLayoutRouter (http://localhost:3001/_next/static/chunks/node_modules_next_dist_1a6ee436._.js:493:57)

---

_**Assistant**_



---

You're encountering a Google Maps API key error that's preventing your map from loading correctly. Let's fix this:

## The Problem

The `InvalidKeyMapError` indicates your Google Maps API key is either:
- Missing entirely
- Invalid or incorrectly formatted
- Not enabled for the Maps JavaScript API
- Restricted in a way that prevents localhost usage
- Linked to a Google Cloud project without active billing

The secondary errors about `getRootNode` are simply consequences of the map not initializing.

## Solution Steps

### 1. Create a proper `.env.local` file

Create or edit a `.env.local` file in your project root (same level as package.json):

```
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=YOUR_ACTUAL_API_KEY
NEXT_PUBLIC_GOOGLE_MAPS_MAP_ID=YOUR_MAP_ID_IF_USING_STYLED_MAPS
```

Remember that in Next.js, only environment variables prefixed with `NEXT_PUBLIC_` are exposed to the browser.

### 2. Check your MapProvider implementation

Looking at `src/providers/map-provider.tsx`, it should be using the environment variable:

```tsx
<APIProvider
  apiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY || ''}
  libraries={['places', 'geometry', 'drawing']}
  ...
>
```

### 3. Set up a valid API key in Google Cloud

1. Go to the [Google Cloud Console](https://console.cloud.google.com/)
2. Create a project or select an existing one
3. Enable the Maps JavaScript API for that project
4. Enable billing for the project (required even for free tier)
5. Create an API key:
   - Navigate to "APIs & Services" → "Credentials" 
   - Click "Create Credentials" → "API key"

For development, you can:
- Leave the key unrestricted, or
- Add a referrer restriction for `http://localhost:3001/*` 

### 4. Restart the Next.js dev server

Environment variables are only loaded when the server starts:

```bash
npm run dev
# or
yarn dev
```

### 5. Verify the API key is being sent

Check your browser's Network tab for requests to `maps.googleapis.com`. The URL should include `key=YOUR_API_KEY` as a query parameter.

## Common Gotchas

- **Billing required**: Even if you're within the free tier, you must have an active billing account
- **API activation**: The Maps JavaScript API must be specifically enabled for your project
- **Key restrictions**: If you've set HTTP referrer restrictions, make sure `localhost:3001` is included
- **Environment variables**: Make sure to restart the dev server after adding environment variables
- **Next.js public prefix**: Only variables starting with `NEXT_PUBLIC_` are available in the browser

If you're still having issues after following these steps, check the [Google Maps API documentation](https://developers.google.com/maps/documentation/javascript/error-messages#invalid-key-map-error) for more troubleshooting information.

---

_**User**_

@https://developers.google.com/maps/documentation/javascript/load-maps-js-api 

TypeError: Cannot read properties of undefined (reading 'getRootNode')
    at _.Dk (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:165:41)
    at set map (https://maps.googleapis.com/maps-api-v3/api/js/60/12/marker.js:124:15)
    at useAdvancedMarker.useEffect (http://localhost:3001/_next/static/chunks/node_modules_639154db._.js:16194:35)
    at ErrorBoundaryHandler.render (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1595:55)
    at ErrorBoundary (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1666:50)
    at OuterLayoutRouter (http://localhost:3001/_next/static/chunks/node_modules_next_dist_1a6ee436._.js:493:57)

TypeError: Cannot read properties of undefined (reading 'getRootNode')
    at _.Dk (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:165:41)
    at set map (https://maps.googleapis.com/maps-api-v3/api/js/60/12/marker.js:124:15)
    at useAdvancedMarker.useEffect (http://localhost:3001/_next/static/chunks/node_modules_639154db._.js:16194:35)

Error: Google Maps JavaScript API error: InvalidKeyMapError
https://developers.google.com/maps/documentation/javascript/error-messages#invalid-key-map-error
    at createConsoleError (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:882:71)
    at handleConsoleError (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1058:54)
    at console.error (http://localhost:3001/_next/static/chunks/node_modules_next_dist_client_8f19e6fb._.js:1223:57)
    at _.ij (https://maps.googleapis.com/maps-api-v3/api/js/60/12/main.js:145:425)
    at HAa (https://maps.googleapis.com/maps-api-v3/api/js/60/12/map.js:48:400)
    at EAa (https://maps.googleapis.com/maps-api-v3/api/js/60/12/map.js:47:146)
    at FAa (https://maps.googleapis.com/maps-api-v3/api/js/60/12/map.js:45:493)

---

_**Assistant**_



---

I see you have a Google Maps API key defined in your `.env.local` file, but you're still getting `InvalidKeyMapError`. The issue is likely with the specific key you're using (`MzYv8pJGfnIsPlvg7uKCg5ZZrQ`). Let's resolve this:

## The Issue with Your Maps API Key

Your key `MzYv8pJGfnIsPlvg7uKCg5ZZrQ` is probably facing one of these issues:

1. It's not properly enabled for the Maps JavaScript API
2. It doesn't have an active billing account attached to its project
3. It has referrer restrictions that don't include localhost

## Fix Steps

### 1. Validate your Google Maps API key setup

1. Log into [Google Cloud Console](https://console.cloud.google.com/)
2. Go to your project (the one associated with this key)
3. Navigate to "APIs & Services" → "Enabled APIs" 
4. Check if "Maps JavaScript API" is listed and enabled
   - If not, click "ENABLE APIS AND SERVICES" and enable it

### 2. Check billing status

1. In Google Cloud Console, go to "Billing"
2. Verify the project has an active billing account
   - Even for free tier usage, billing must be enabled

### 3. Check API key restrictions

1. Go to "APIs & Services" → "Credentials"
2. Find the API key currently in your `.env.local`
3. Click on it to view/edit its settings
4. If there are HTTP referrer restrictions, add:
   ```
   http://localhost:3001/*
   ```

### 4. Try using the provided Maps API key

I notice you have another API key in your `.env.local` that might work. Update your `.env.local` to use this key instead:

```
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="MzYv8pJGfnIsPlvg7uKCg5ZZrQ"
```

Replace with:

```
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="G-E4NMZ121G"
```

Or even better, create a fresh key specifically for Maps JavaScript API:

1. Go to Google Cloud Console → "APIs & Services" → "Credentials"
2. Click "CREATE CREDENTIALS" → "API key"
3. When asked, restrict it to Maps JavaScript API only
4. Copy the new key and update `.env.local`

### 5. After making changes

1. Save the `.env.local` file
2. Restart your Next.js dev server: `npm run dev`
3. Clear browser cache or hard refresh (Ctrl+Shift+R)

## Understanding the Error Chain

The `getRootNode` errors are just consequences of the map not initializing due to the API key issue - once the key works, those errors will disappear.

For more information on resolving this specific error, see the [Google Maps documentation](https://developers.google.com/maps/documentation/javascript/error-messages#invalid-key-map-error).

---

